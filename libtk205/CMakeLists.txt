cmake_minimum_required(VERSION 3.0.0)
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
project(libtk205)

include(CTest)
set(JSON_BuildTests OFF CACHE INTERNAL "")

# include_directories adds locations to the -I command line
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/vendor/btwxt/src)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/vendor/json/single_include)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/vendor/json/include)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/build/include)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)

add_subdirectory(vendor/btwxt)

list(APPEND Factory_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/include/rs_instance_factory.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/rs_instance_factory.cpp"
                            "${CMAKE_CURRENT_SOURCE_DIR}/include/rs_instance_base.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/include/performance_map_base.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/include/grid_variables_base.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/include/lookup_variables_base.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0001_factory.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0001_factory.cpp"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0002_factory.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0002_factory.cpp"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0003_factory.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0003_factory.cpp"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0004_factory.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0004_factory.cpp"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0005_factory.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0005_factory.cpp"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0006_factory.h"
                            "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0006_factory.cpp"
)
list(APPEND RS_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/ASHRAE205.cpp"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/ASHRAE205.h"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0001.h"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0001.cpp"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0002.h"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0002.cpp"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0003.h"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0003.cpp"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0004.h"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0004.cpp"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0005.h"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0005.cpp"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/include/RS0006.h"
                       "${CMAKE_CURRENT_SOURCE_DIR}/src/build/cpp/RS0006.cpp"
)

add_custom_target(generate_cpp ALL 
                  COMMAND poetry run doit headers
                  COMMAND poetry run doit cpp
                  WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/../schema-205")

# copy_directory will create the destination if it does not exist
add_custom_target(copy_generated_source ALL
                  COMMAND ${CMAKE_COMMAND} -E make_directory "${PROJECT_SOURCE_DIR}/include"
                  COMMAND ${CMAKE_COMMAND} -E make_directory "${PROJECT_SOURCE_DIR}/src/build/include"
                  COMMAND ${CMAKE_COMMAND} -E make_directory "${PROJECT_SOURCE_DIR}/src/build/cpp"
                  COMMAND ${CMAKE_COMMAND} "-DPROJECT_SOURCE_DIR=${PROJECT_SOURCE_DIR}" -P "${PROJECT_SOURCE_DIR}/cmake/copy_template_generated_files.cmake"
                  COMMAND ${CMAKE_COMMAND} "-DPROJECT_SOURCE_DIR=${PROJECT_SOURCE_DIR}" -P "${PROJECT_SOURCE_DIR}/cmake/copy_autogenerated_files.cmake")

set (SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/include/libtk205.h"
             "${CMAKE_CURRENT_SOURCE_DIR}/src/libtk205.cpp"
             "${CMAKE_CURRENT_SOURCE_DIR}/include/error_handling_tk205.h"
             "${CMAKE_CURRENT_SOURCE_DIR}/src/error_handling_tk205.cpp"
             ${Factory_SOURCES} 
             ${RS_SOURCES})
# The GENERATED property prevents the source files being used before they exist.
set_source_files_properties(${SOURCES} PROPERTIES GENERATED TRUE)

add_library(libtk205 src/libtk205.cpp ${SOURCES})
target_link_libraries(libtk205 btwxt)
add_dependencies(libtk205 copy_generated_source)
add_dependencies(copy_generated_source generate_cpp)

# add_executable(libtktest src/load.cpp)
# target_link_libraries(libtktest libtk205)

add_subdirectory(vendor)
if (BUILD_TK205_TESTING)
  add_compile_definitions(TEST205_INPUT_EXAMPLES_DIR="${TEST205_INPUT_EXAMPLES_DIR}")
  add_subdirectory(test)
endif()

set(CPACK_PROJECT_NAME ${PROJECT_NAME})
set(CPACK_PROJECT_VERSION ${PROJECT_VERSION})
include(CPack)
